{"version":3,"sources":["../../src/cli/utils.js"],"names":["path","require","process","CliUtils","constructor","opts","isVerbose","verbose","debug","isDebug","isMessage","isError","isWarning","latestLength","_getCaller","depth","reStackTrace","n","stack","Error","result","exec","join","basename","dirname","_hook","stdoutWrite","stdout","write","stderrWrite","stderr","exit","rotateIndex","timer","setInterval","indicator","substr","apply","_reset","clearInterval","repeat","args","mesg","header","caller","console","log","length","message","warning","error","module","exports"],"mappings":"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","file":"utils.js","sourcesContent":["'use strict'\n\nconst path = require('path')\nconst process = require('process')\n\nclass CliUtils {\n    constructor(opts = {}) {\n        this.isVerbose = opts.verbose || opts.debug\n        this.isDebug = opts.debug\n        this.isMessage = true\n        this.isError = true\n        this.isWarning = true\n\n        this.latestLength = 0\n    }\n\n    _getCaller(depth) {\n        const reStackTrace = /at .+ \\(([^:]+:[0-9]+:[0-9]+)\\)/g\n\n        let n = depth + 2\n\n        const {stack} = new Error()\n        let result\n        while ((result = reStackTrace.exec(stack)) !== null) {\n            if (--n <= 0) {\n                return path.join(path.basename(path.dirname(result[1])), path.basename(result[1]))\n            }\n        }\n        return null\n    }\n\n    _hook() {\n        const stdoutWrite = process.stdout.write\n        const stderrWrite = process.stderr.write\n        const exit = process.exit\n\n        let rotateIndex = 0\n\n        // Fixme: it can not be stopped while using hooks because it uses setInterval.\n        let timer = setInterval(() => {\n            const indicator = '|/-\\\\'.substr(rotateIndex, 1)\n            if (++rotateIndex >= 4) {\n                rotateIndex = 0\n            }\n\n            stdoutWrite.apply(process.stdout, [`${indicator}\\r`])\n        }, 50)\n\n        const _reset = () => {\n            clearInterval(timer)\n            process.stdout.write = stdoutWrite\n            process.stderr.write = stderrWrite\n            process.exit = exit\n            if (this.latestLength > 0) {\n                process.stdout.write(`${' '.repeat(this.latestLength)}\\r`)\n                this.latestLength = 0\n            }\n        }\n\n        process.exit = (...args) => {\n            _reset()\n            process.exit(...args)\n        }\n\n        process.stdout.write = (...args) => {\n            _reset()\n            process.stdout.write(...args)\n        }\n\n        process.stderr.write = (...args) => {\n            _reset()\n            process.stderr.write(...args)\n        }\n    }\n\n    /**\n     *\n     * @param {string} [mesg]\n     * @param {number} [depth]\n     */\n    verbose(mesg = '', depth = 0) {\n        let header = ''\n        const caller = this._getCaller(depth + 1)\n        if (this.isDebug && caller) {\n            header = `verbose ${caller}`\n        } else {\n            header = 'verbose'\n        }\n\n        if (this.isVerbose) {\n            console.log(`\\x1b[33m${header}:\\x1b[m ${mesg}`)\n        } else {\n            process.stdout.write(`  ${mesg}\\r`)\n            this.latestLength = mesg.length + 2\n            this._hook()\n        }\n    }\n\n    /**\n     *\n     * @param {string} [mesg]\n     * @param {number} [depth]\n     */\n    debug(mesg = '', depth = 0) {\n        if (this.isDebug) {\n            const header = `debug ${this._getCaller(depth + 1)}`\n            console.log(`\\x1b[36m${header}:\\x1b[m ${mesg}`)\n        }\n    }\n\n    /**\n     *\n     * @param {string} [mesg]\n     * @param {number} [depth]\n     */\n    message(mesg = '', depth = 0) {\n        if (this.isMessage) {\n            let header = ''\n            if (this.isDebug) {\n                console.log(`\\x1b[32m${this._getCaller(depth + 1)}\\x1b[m: ${mesg}`)\n            } else {\n                console.log(mesg)\n            }\n        }\n    }\n\n    /**\n     *\n     * @param {string} [mesg]\n     * @param {number} [depth]\n     */\n    warning(mesg = '', depth = 0) {\n        if (this.isWarning) {\n            let header = ''\n            if (this.isDebug) {\n                header = `warning ${this._getCaller(depth + 1)}`\n            } else {\n                header = 'warning'\n            }\n            console.log(`\\x1b[33m${header}:\\x1b[m ${mesg}`)\n        }\n    }\n\n    error(mesg = '', depth = 0) {\n        if (this.isError) {\n            let header = ''\n            if (this.isDebug) {\n                header = `error ${this._getCaller(depth + 1)}`\n            } else {\n                header = 'error'\n            }\n            console.log(`\\x1b[33m${header}:\\x1b[m ${mesg}`)\n        }\n    }\n\n}\n\nmodule.exports = CliUtils\n"]}