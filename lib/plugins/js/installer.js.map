{"version":3,"sources":["../../../src/plugins/js/installer.js"],"names":["utils","getConfig","require","path","fs","JsInstaller","constructor","operator","json","readFileSync","_init","values","JSON","parse","e","packages","devPackages","isYarn","getOpt","includes","config","getProjectName","getProjectDir","main","name","version","description","author","getAuthor","license","getGlobal","keywords","scripts","start","build","watch","test","bin","innocentia","getInstaller","addPackage","checkExistsNpm","push","addDevPackage","addBin","binPath","basename","setMain","setInnocentiaConfig","key","obj","install","babelInstaller","addPreset","noUse","getNoUse","defaultUse","Promise","all","filter","value","map","webpackInstaller","addLoader","loader","options","sourceMap","postInstall","writeFile","stringify","isRewritable","length","addCommand","join","module","exports"],"mappings":"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","file":"installer.js","sourcesContent":["'use strict'\n\nconst {utils, getConfig} = require('../../waterslide')\nconst path = require('path')\nconst fs = require('fs')\n\nclass JsInstaller {\n    constructor(operator) {\n        this.operator = operator\n\n        try {\n            const json = operator.readFileSync('package.json')\n            if (!json) {\n                this._init()\n            } else {\n                this.values = JSON.parse(json)\n            }\n        } catch (e) {\n            this._init()\n        }\n\n        this.packages = []\n        this.devPackages = []\n\n        this.isYarn = this.operator.getOpt().includes('yarn')\n    }\n\n    _init() {\n        const config = getConfig()\n\n        const getProjectName = () => this.operator.getProjectDir()\n        // FIXME: project dir -> project name\n\n        this.values = {\n            main: '',\n            name: getProjectName(),\n            version: '0.0.1',\n            description: '',\n            author: config.getAuthor(),\n            license: config.getGlobal('license'),\n            keywords: [],\n            scripts: {\n                start: 'innocentia run',\n                build: 'innocentia build',\n                watch: 'ws watch',\n                test: 'innocentia test'\n            },\n            bin: {},\n            innocentia: {},\n        }\n    }\n\n    static getInstaller(operator) {\n        return new this(operator)\n    }\n\n    addPackage(name) {\n        if (utils.checkExistsNpm(name)) {\n            return\n        }\n\n        this.packages.push(name)\n    }\n\n    addDevPackage(name) {\n        if (utils.checkExistsNpm(name)) {\n            return\n        }\n\n        this.devPackages.push(name)\n    }\n\n    addBin(binPath) {\n        this.values.bin[path.basename(binPath)] = binPath\n    }\n\n    setMain(name) {\n        this.values.main = name\n    }\n\n    setInnocentiaConfig(key, obj) {\n        this.values.innocentia[key] = obj\n    }\n\n    async install() {\n        this.addDevPackage('babel-core')\n        this.addDevPackage('babel-loader')\n\n        const babelInstaller = await this.operator.getInstaller('babel')\n        if (this.operator.getOpt().includes('es2015')) {\n            this.addDevPackage('babel-preset-es2015')\n            babelInstaller.addPreset('es2015')\n        } else {\n            this.addDevPackage('babel-preset-es2016')\n            babelInstaller.addPreset('es2016')\n        }\n\n        this.addDevPackage('~/work/innocentia')\n\n        const noUse = this.operator.getNoUse()\n        const defaultUse = ['power-assert', 'ava', 'eslint']\n        await Promise.all(defaultUse.filter(value => !noUse.includes(value)).map(async value => await this.operator.getInstaller(value)))\n\n        const webpackInstaller = await this.operator.getInstaller('webpack')\n        webpackInstaller.addLoader('\\\\.jsx?$', [\n            {loader: 'babel-loader', options: {sourceMap: true}}\n        ])\n\n        this.operator.postInstall(async () => {\n            await this.operator.writeFile('package.json', `${JSON.stringify(this.values, null, '  ')}\\n`, {isRewritable: true})\n\n\n            if (this.isYarn) {\n                if (this.packages.length > 0) {\n                    this.operator.addCommand(3, `yarn add ${this.packages.join(' ')} -S`)\n                }\n                if (this.devPackages.length > 0) {\n                    this.operator.addCommand(3, `yarn add ${this.devPackages.join(' ')} -D`)\n                }\n            } else {\n                if (this.packages.length > 0) {\n                    this.operator.addCommand(3, `npm i ${this.packages.join(' ')} -S`)\n                }\n                if (this.devPackages.length > 0) {\n                    this.operator.addCommand(3, `npm i ${this.devPackages.join(' ')} -D`)\n                }\n            }\n\n        })\n    }\n}\n\nmodule.exports = JsInstaller\n"]}