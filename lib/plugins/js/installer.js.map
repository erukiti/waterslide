{"version":3,"sources":["../../../src/plugins/js/installer.js"],"names":["utils","getConfig","require","path","fs","JsInstaller","constructor","operator","json","readFileSync","_init","values","JSON","parse","e","packages","devPackages","config","getProjectName","getProjectDir","main","name","version","description","author","getAuthor","license","getGlobal","keywords","scripts","start","build","watch","test","bin","getInstaller","addPackage","priorityAddition","checkExistsNpm","push","addCommand","addDevPackage","addBin","binPath","basename","setMain","install","babelInstaller","getOpt","includes","addPreset","noUse","getNoUse","defaultUse","Promise","all","filter","value","map","webpackInstaller","addLoader","loader","options","sourceMap","postInstall","writeFile","stringify","isRewritable","module","exports"],"mappings":"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","file":"installer.js","sourcesContent":["'use strict'\n\nconst {utils, getConfig} = require('../../waterslide')\nconst path = require('path')\nconst fs = require('fs')\n\nclass JsInstaller {\n    constructor(operator) {\n        this.operator = operator\n\n        try {\n            const json = operator.readFileSync('package.json')\n            if (!json) {\n                this._init()\n            } else {\n                this.values = JSON.parse(json)\n            }\n        } catch (e) {\n            this._init()\n        }\n\n        this.packages = []\n        this.devPackages = []\n    }\n\n    _init() {\n        const config = getConfig()\n\n        const getProjectName = () => this.operator.getProjectDir()\n        // FIXME: project dir -> project name\n\n        this.values = {\n            main: '',\n            name: getProjectName(),\n            version: '0.0.1',\n            description: '',\n            author: config.getAuthor(),\n            license: config.getGlobal('license'),\n            keywords: [],\n            scripts: {\n                start: 'ws run',\n                build: 'ws build',\n                watch: 'ws watch',\n                test: 'ws test'\n            },\n            bin: {},\n        }\n    }\n\n    static getInstaller(operator) {\n        return new this(operator)\n    }\n\n    addPackage(name, priorityAddition = 0) {\n        if (utils.checkExistsNpm(name)) {\n            return\n        }\n\n        this.packages.push(name)\n        this.operator.addCommand(3 + priorityAddition, `npm install ${name} -S`)\n    }\n\n    addDevPackage(name, priorityAddition = 0) {\n        if (utils.checkExistsNpm(name)) {\n            return\n        }\n\n        this.devPackages.push(name)\n        this.operator.addCommand(3 + priorityAddition, `npm install ${name} -D`)\n    }\n\n    addBin(binPath) {\n        this.values.bin[path.basename(binPath)] = binPath\n    }\n\n    setMain(name) {\n        this.values.main = name\n    }\n\n    async install() {\n        this.addDevPackage('babel-core')\n        this.addDevPackage('babel-loader')\n\n        const babelInstaller = await this.operator.getInstaller('babel')\n        if (this.operator.getOpt().includes('es2015')) {\n            this.addDevPackage('babel-preset-es2015')\n            babelInstaller.addPreset('es2015')\n        } else {\n            this.addDevPackage('babel-preset-es2016')\n            babelInstaller.addPreset('es2016')\n        }\n\n        this.addDevPackage('waterslide')\n\n        const noUse = this.operator.getNoUse()\n        const defaultUse = ['power-assert', 'ava', 'eslint']\n        await Promise.all(defaultUse.filter(value => !noUse.includes(value)).map(async value => await this.operator.getInstaller(value)))\n\n        const webpackInstaller = await this.operator.getInstaller('webpack')\n        webpackInstaller.addLoader('\\\\.jsx?$', [\n            {loader: 'babel-loader', options: {sourceMap: true}}\n        ])\n\n        this.operator.postInstall(async () => {\n            await this.operator.writeFile('package.json', `${JSON.stringify(this.values, null, '  ')}\\n`, {isRewritable: true})\n        })\n    }\n}\n\nmodule.exports = JsInstaller\n"]}