{"version":3,"sources":["../../../src/plugins/js/installer.js"],"names":["utils","getConfig","require","path","fs","JsInstaller","constructor","operator","json","readFileSync","_init","values","JSON","parse","e","packages","devPackages","isYarn","getOpt","includes","config","getProjectName","getProjectDir","main","name","version","description","author","getAuthor","license","getGlobal","keywords","scripts","start","build","watch","test","bin","getInstaller","addPackage","checkExistsNpm","push","addDevPackage","addBin","binPath","basename","setMain","install","babelInstaller","addPreset","noUse","getNoUse","defaultUse","Promise","all","filter","value","map","webpackInstaller","addLoader","loader","options","sourceMap","postInstall","writeFile","stringify","isRewritable","length","addCommand","join","module","exports"],"mappings":"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","file":"installer.js","sourcesContent":["'use strict'\n\nconst {utils, getConfig} = require('../../waterslide')\nconst path = require('path')\nconst fs = require('fs')\n\nclass JsInstaller {\n    constructor(operator) {\n        this.operator = operator\n\n        try {\n            const json = operator.readFileSync('package.json')\n            if (!json) {\n                this._init()\n            } else {\n                this.values = JSON.parse(json)\n            }\n        } catch (e) {\n            this._init()\n        }\n\n        this.packages = []\n        this.devPackages = []\n\n        this.isYarn = this.operator.getOpt().includes('yarn')\n    }\n\n    _init() {\n        const config = getConfig()\n\n        const getProjectName = () => this.operator.getProjectDir()\n        // FIXME: project dir -> project name\n\n        this.values = {\n            main: '',\n            name: getProjectName(),\n            version: '0.0.1',\n            description: '',\n            author: config.getAuthor(),\n            license: config.getGlobal('license'),\n            keywords: [],\n            scripts: {\n                start: 'ws run',\n                build: 'ws build',\n                watch: 'ws watch',\n                test: 'ws test'\n            },\n            bin: {},\n        }\n    }\n\n    static getInstaller(operator) {\n        return new this(operator)\n    }\n\n    addPackage(name) {\n        if (utils.checkExistsNpm(name)) {\n            return\n        }\n\n        this.packages.push(name)\n    }\n\n    addDevPackage(name) {\n        if (utils.checkExistsNpm(name)) {\n            return\n        }\n\n        this.devPackages.push(name)\n    }\n\n    addBin(binPath) {\n        this.values.bin[path.basename(binPath)] = binPath\n    }\n\n    setMain(name) {\n        this.values.main = name\n    }\n\n    async install() {\n        this.addDevPackage('babel-core')\n        this.addDevPackage('babel-loader')\n\n        const babelInstaller = await this.operator.getInstaller('babel')\n        if (this.operator.getOpt().includes('es2015')) {\n            this.addDevPackage('babel-preset-es2015')\n            babelInstaller.addPreset('es2015')\n        } else {\n            this.addDevPackage('babel-preset-es2016')\n            babelInstaller.addPreset('es2016')\n        }\n\n        this.addDevPackage('waterslide')\n\n        const noUse = this.operator.getNoUse()\n        const defaultUse = ['power-assert', 'ava', 'eslint']\n        await Promise.all(defaultUse.filter(value => !noUse.includes(value)).map(async value => await this.operator.getInstaller(value)))\n\n        const webpackInstaller = await this.operator.getInstaller('webpack')\n        webpackInstaller.addLoader('\\\\.jsx?$', [\n            {loader: 'babel-loader', options: {sourceMap: true}}\n        ])\n\n        this.operator.postInstall(async () => {\n            await this.operator.writeFile('package.json', `${JSON.stringify(this.values, null, '  ')}\\n`, {isRewritable: true})\n\n\n            if (this.isYarn) {\n                if (this.packages.length > 0) {\n                    this.operator.addCommand(3, `yarn add ${this.packages.join(' ')} -S`)\n                }\n                if (this.devPackages.length > 0) {\n                    this.operator.addCommand(3, `yarn add ${this.devPackages.join(' ')} -D`)\n                }\n            } else {\n                if (this.packages.length > 0) {\n                    this.operator.addCommand(3, `npm i ${this.packages.join(' ')} -S`)\n                }\n                if (this.devPackages.length > 0) {\n                    this.operator.addCommand(3, `npm i ${this.devPackages.join(' ')} -D`)\n                }\n            }\n\n        })\n    }\n}\n\nmodule.exports = JsInstaller\n"]}